<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-fire.png?v=6.4.1"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-fire.png?v=6.4.1"><link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"6.4.1",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="Java 9引入了一个新的孵化HttpClient API来处理HTTP请求。从Java 11开始，这个API已经可以在标准库 java.net 中使用了。这个新的 HttpClient 既可以被同步使用，也可以被异步使用。本文将以最新的Java 11 为标准，详细介绍HttpClient API的主要功能以及使用方式。"><meta name="keywords" content="IT技术,Java,新特性"><meta property="og:type" content="article"><meta property="og:title" content="从Java 8 到Java 11 （语言篇）：二、Java的Http客户端"><meta property="og:url" content="https://snowolf.gitee.io/2018/10/03/1/index.html"><meta property="og:site_name" content="焰冰封"><meta property="og:description" content="Java 9引入了一个新的孵化HttpClient API来处理HTTP请求。从Java 11开始，这个API已经可以在标准库 java.net 中使用了。这个新的 HttpClient 既可以被同步使用，也可以被异步使用。本文将以最新的Java 11 为标准，详细介绍HttpClient API的主要功能以及使用方式。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://snowolf.gitee.io/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/thumb.jpg"><meta property="og:updated_time" content="2019-01-04T06:57:45.084Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="从Java 8 到Java 11 （语言篇）：二、Java的Http客户端"><meta name="twitter:description" content="Java 9引入了一个新的孵化HttpClient API来处理HTTP请求。从Java 11开始，这个API已经可以在标准库 java.net 中使用了。这个新的 HttpClient 既可以被同步使用，也可以被异步使用。本文将以最新的Java 11 为标准，详细介绍HttpClient API的主要功能以及使用方式。"><meta name="twitter:image" content="https://snowolf.gitee.io/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/thumb.jpg"><link rel="alternate" href="/atom.xml" title="焰冰封" type="application/atom+xml"><link rel="canonical" href="https://snowolf.gitee.io/2018/10/03/1/"><script type="text/javascript" id="page.configurations">CONFIG.page={sidebar:""}</script><title>从Java 8 到Java 11 （语言篇）：二、Java的Http客户端 | 焰冰封</title><noscript><style type="text/css">.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://gitee.com/snowolf/blog.git" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">焰冰封</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">个人博客</p></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-top"><a href="/top/" rel="section"><i class="menu-item-icon fa fa-fw fa-signal"></i><br>排行榜</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><div class="reading-progress-bar"></div><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://snowolf.gitee.io/2018/10/03/1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Snowolf Lee"><meta itemprop="description" content="知行合一  笃行求是"><meta itemprop="image" content="/images/sai.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="焰冰封"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">从Java 8 到Java 11 （语言篇）：二、Java的Http客户端</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-10-03 10:53:15" itemprop="dateCreated datePublished" datetime="2018-10-03T10:53:15+08:00">2018-10-03</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-01-04 14:57:45" itemprop="dateModified" datetime="2019-01-04T14:57:45+08:00">2019-01-04</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/IT技术/" itemprop="url" rel="index"><span itemprop="name">IT技术</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/IT技术/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/IT技术/Java/从Java-8-到Java-11/" itemprop="url" rel="index"><span itemprop="name">从Java 8 到Java 11</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <a href="/2018/10/03/1/#comments" itemprop="discussionUrl"><span class="post-meta-item-text">评论数：</span><span class="post-comments-count valine-comment-count" data-xid="/2018/10/03/1/" itemprop="commentCount"></span></a></span> <span id="/2018/10/03/1/" class="leancloud_visitors" data-flag-title="从Java 8 到Java 11 （语言篇）：二、Java的Http客户端"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span> <span>℃</span></span><div class="post-description">Java 9引入了一个新的孵化HttpClient API来处理HTTP请求。从Java 11开始，这个API已经可以在标准库 java.net 中使用了。这个新的 HttpClient 既可以被同步使用，也可以被异步使用。本文将以最新的Java 11 为标准，详细介绍HttpClient API的主要功能以及使用方式。</div></div></header><div class="post-body" itemprop="articleBody"><div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery"><div class="post-gallery-row"> <a class="post-gallery-img fancybox" href="/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/thumb.jpg" rel="gallery_cjqhp9bvh0007f8e6zg1nqitg" itemscope itemtype="http://schema.org/ImageObject" itemprop="url"><img src="/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/thumb.jpg" itemprop="contentUrl"></a></div></div><p>&emsp;&emsp;在 Java SE 9 中，Oracle 公司将发布新的 HTTP 2 Client API 来支持 HTTP/2 协议和 WebSocket 特性。现有的 HTTP Client API 存在很多问题（如支持 HTTP/1.1 协议但是不支持 HTTP/2 协议和 WebSocket，仅仅作用在 Blocking 模式中，并存在大量性能问题），他们正在被使用新的 HTTP 客户端的 HttpURLConnection API 所替代。</p><p>&emsp;&emsp;Oracle 公司在 “java.net.http” 模块下引入新的 HTTP 2 Client API。它将同时支持 HTTP/1.1 和 HTTP/2 协议，也同时支持同步（Blocking Mode）和异步模式，支持 WebSocket API 使用中的异步模式。</p><h2 id="什么是HTTP-2"><a href="#什么是HTTP-2" class="headerlink" title="什么是HTTP/2"></a>什么是HTTP/2</h2><p>&emsp;&emsp;HTTP/1.1是当前web应用使用最广泛和最成功的协议之一。在过去的16年中，HTTP/1.1对于互联网的发展是有利的，但是协议的细微问题已经开始出现。例如，资源密集型的Web应用程序有较大的减速的可能性，因为HTTP/1.1每个TCP连接只允许一个未完成的请求。</p><p>&emsp;&emsp;HTTP/2是HTTP/1.1规范的替代品。尽管它是一个替代品，核心功能，状态代码等仍然是一样的。因此，这不是现有HTTP/1.1规范的完整返工。通过HTTP/2，IETF HTTP工作组旨在提供更优化的协议版本，具有更好的最终用户隐私，客户端和源资源分配。</p><p>&emsp;&emsp;HTTP/2 可以让我们的应用更快、更简单、更稳定。其目的是通过支持完整的请求与响应复用来减少延迟，通过有效压缩 HTTP 标头字段将协议开销降至最低，同时增加对请求优先级和服务器推送的支持。为达成这些目标，HTTP/2 还给我们带来了大量其他协议层面的辅助实现，例如新的流控制、错误处理和升级机制。</p><p>&emsp;&emsp;HTTP/2 没有改动 HTTP 的应用语义。HTTP 方法、状态代码、URI 和标头字段等核心概念一如往常。不过，HTTP/2 修改了数据格式化（分帧）以及在客户端与服务器间传输的方式。这两点统帅全局，通过新的分帧层向我们的应用隐藏了所有复杂性。因此，所有现有的应用都可以不必修改而在新协议下运行。<br><img src="/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/binary_framing_layer01.svg" alt="分帧层"></p><h2 id="Http客户端API基本使用"><a href="#Http客户端API基本使用" class="headerlink" title="Http客户端API基本使用"></a>Http客户端API基本使用</h2><p>&emsp;&emsp;直到Java 1.8，Java只提供了对HTTP/1.1的支持。因此，一些Java开发人员不得不依赖其他客户端，如Jetty的ALPN（Application Layer Protocol Negotiation，应用层协议协商）来编写与支持HTTP/2协议的服务器进行交互的客户端代码。为了方便开发人员使用统一的Http客户端，2014年，创建了JDK增强建议（<a href="http://openjdk.java.net/jeps/110" target="_blank" rel="noopener">JEP 110</a>）,定义实现HTTP/2和WebSockets的新HTTP客户端API，该增强建议中的内容在Java SE 9中得到了体现。在Java SE 10中，通过<a href="http://openjdk.java.net/jeps/321" target="_blank" rel="noopener">JEP 321</a>, 对Http 客户端API进行了增强，新版本的HTTP客户端（java.net.http模块） 除了实现了HTTP(1.1和2)、WebSocket，同步和异步调用以及Reactive Streams，还提供了清晰易懂的流式API。</p><h3 id="引入Http客户端模块"><a href="#引入Http客户端模块" class="headerlink" title="引入Http客户端模块"></a>引入Http客户端模块</h3><p>&emsp;&emsp;Java SE 9引入了模块系统，在之后的版本，需要使用其他模块时，需要在模块什么中指定其所依赖的模块。在使用Http客户端的时候，需要先在模块声明中引入该模块。如下代码所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> com.snowolf.tutorial &#123;</span><br><span class="line">    <span class="keyword">requires</span> java.net.http;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建HTTP客户端"><a href="#创建HTTP客户端" class="headerlink" title="创建HTTP客户端"></a>创建HTTP客户端</h3><p>&emsp;&emsp;创建HTTP客户端需要使用HttpClient抽象类，它提供了两种方法创建HttpClient对象：</p><ul><li>使用HttpClient类的newHttpClient()静态方法</li></ul><p>&emsp;&emsp;这种方式创建的HttpClient对象默认使用的HTTP协议版本是1.1，如果需要创建2.0版本的，需要使用其他的API。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var client = HttpClient.newHttpClient();</span><br></pre></td></tr></table></figure><ul><li>使用HttpClient.Builder类的build()方法</li></ul><p>&emsp;&emsp;可以使用HttpClient.newBuilder()静态方法，创建一个新的HttpClient.Builder类实例。 HttpClient.Builder类提供了一些列配置方法，而且支持链式调用，只需要在最后调用返回HttpClient对象的build()方法，就可以创建一个HttpClient对象。 以下语句创建一个HttpClient，重定向策略设置为ALWAYS，HTTP版本设置为2.0：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var client = HttpClient.newBuilder()</span><br><span class="line">                    .version(Version.HTTP_2)   <span class="comment">//指定HTTP协议版本</span></span><br><span class="line">                    .followRedirects(Redirect.ALWAYS) <span class="comment">//指定重定向策略</span></span><br><span class="line">                    .build();</span><br></pre></td></tr></table></figure><h3 id="创建HTTP请求"><a href="#创建HTTP请求" class="headerlink" title="创建HTTP请求"></a>创建HTTP请求</h3><p>&emsp;&emsp; HTTP/2 仍是对之前 HTTP 标准的扩展，而非替代。 HTTP 的应用语义不变，提供的功能不变，HTTP 方法、状态代码、URI 和标头字段等这些核心概念也不变。这些方面的变化都不在 HTTP/2 考虑之列。对于用户来说，HTTP/2的请求所需要的包含的内容与HTTP 1.1是一样的，它们同样是请求方法、URI、请求头以及请求体这些内容。如下图：<br><img src="/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/02.png" alt="HTTP请求"></p><p>&emsp;&emsp;这也就说明在创建HTTP请求时，只需要关心请求方法、URI、请求头（HttpHeaders）和请求体这些内容。创建HTTP请求需要使用HttpRequest抽象类，示例代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var req = HttpRequest.newBuilder() <span class="comment">//创建HttpRequest.Builder</span></span><br><span class="line">             <span class="comment">//指定请求地址,也可以在newBuilder(URI.create("http://openjdk.java.net/"))时指定。</span></span><br><span class="line">            .uri(URI.create(<span class="string">"http://openjdk.java.net/"</span>)) </span><br><span class="line">            .header(<span class="string">"Accept"</span>, <span class="string">"text/html,*/*;q=0.8"</span>)  <span class="comment">//设置请求头</span></span><br><span class="line">            .timeout(Duration.ofMinutes(<span class="number">1</span>)) <span class="comment">//设置超时时长</span></span><br><span class="line">            .GET() <span class="comment">//指定请求方法</span></span><br><span class="line">            .build();</span><br></pre></td></tr></table></figure><h3 id="处理HTTP响应"><a href="#处理HTTP响应" class="headerlink" title="处理HTTP响应"></a>处理HTTP响应</h3><p>&emsp;&emsp;按照HTTP的规范，一般来说，其响应包含状态码，响应头和响应体组成。那么在处理响应的时候，也就是对这三个方面的数据进行处理。<br><img src="/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/03.png" alt="HTTP响应"></p><p>&emsp;&emsp;创建完成HttpRequest之后，可以使用HttpClient将请求发送到服务器，并同步或异步地接收响应。HttpResponse类的实例表示从服务器接收到的响应。可以通过其内部接口HttpResponse.BodyHandler的实现类来处理Http响应。HttpResponse.BodyHandlers提供了常用的响应处理方法。HttpResponse.BodyHandler会将处理的结果封装到HttpResponse对象中。</p><h3 id="发送HTTP请求"><a href="#发送HTTP请求" class="headerlink" title="发送HTTP请求"></a>发送HTTP请求</h3><p>&emsp;&emsp;Http客户端API支持发送同步和异步的请求，在Java SE 10中，HttpClient 既可以被同步使用，也可以被异步使用。同步请求将会阻塞当前的线程，直到返回响应消息。BodyHandlers 定义了响应消息体的类型（例如string，byte-array 或 file）。示例代码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var response = client.send(request, HttpResponse.BodyHandlers.ofString()); <span class="comment">//同步请求</span></span><br><span class="line">System.out.println(response.statusCode()); <span class="comment">// 打印状态码</span></span><br><span class="line">response.headers().map()</span><br><span class="line">    .forEach((k,v) -&gt; System.out.println(k + <span class="string">": "</span> + v)); <span class="comment">// 打印响应头</span></span><br><span class="line">System.out.println(response.body()); <span class="comment">// 打印响应体</span></span><br></pre></td></tr></table></figure><p>同样的请求也可以被异步执行。调用 sendAsync 方法不会阻塞当前线程，并且会返回 CompletableFuture 对象，用来构建异步执行结果的操作流。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var response = client.sendAsync(request, HttpResponse.BodyHandlers.ofString());</span><br><span class="line">response.thenApply(HttpResponse::statusCode) <span class="comment">//打印状态码</span></span><br><span class="line">        .thenAccept(System.out::println);</span><br><span class="line">response.thenApply(HttpResponse::headers) <span class="comment">// 打印响应头</span></span><br><span class="line">        .thenAccept( headers -&gt; &#123;</span><br><span class="line">            headers.map().forEach((k,v) -&gt; System.out.println(k + <span class="string">": "</span> + v));</span><br><span class="line">        &#125;);</span><br><span class="line">response.thenApply(HttpResponse::body) <span class="comment">// 打印响应体</span></span><br><span class="line">        .thenAccept(System.out::println);</span><br></pre></td></tr></table></figure><h3 id="基本请求认证"><a href="#基本请求认证" class="headerlink" title="基本请求认证"></a>基本请求认证</h3><p>&emsp;&emsp;HTTP API提供了一个Authenticator抽象类来描述HTTP认证信息。它提供不同的认证方案（例如，基本或摘要认证）。 在大多数情况下，身份验证需要用户名和密码才能连接到服务器，我们可以使用PasswordAuthentication类来实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var client = HttpClient.newBuilder()</span><br><span class="line">            .authenticator(<span class="keyword">new</span> Authenticator() &#123; <span class="comment">// 指定认证的账号和密码</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> PasswordAuthentication <span class="title">getPasswordAuthentication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> PasswordAuthentication(<span class="string">"postman"</span>, <span class="string">"password"</span>.toCharArray());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).build();</span><br><span class="line">var request = HttpRequest.newBuilder(</span><br><span class="line">                URI.create(<span class="string">"https://postman-echo.com/basic-auth"</span>))</span><br><span class="line">            .build(); <span class="comment">// 创建HttpRequest.Builder</span></span><br><span class="line">var response = client.send(request, HttpResponse.BodyHandlers.ofString());</span><br><span class="line">System.out.println(response.statusCode()); <span class="comment">// 200</span></span><br></pre></td></tr></table></figure><h3 id="使用代理"><a href="#使用代理" class="headerlink" title="使用代理"></a>使用代理</h3><p>&emsp;&emsp;HTTP API支持通过代理的方式访问网络，它提供了ProxySelector抽象类来设置代理对象。它提供默认提供操作系统的代理方式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var client = HttpClient.newBuilder()</span><br><span class="line">                    .proxy(ProxySelector.getDefault()) <span class="comment">//设置代理服务器</span></span><br><span class="line">                    .build();</span><br><span class="line">var request = HttpRequest.newBuilder(</span><br><span class="line">                URI.create(<span class="string">"http://www.baidu.com"</span>))</span><br><span class="line">            .build(); <span class="comment">// 创建HttpRequest.Builder</span></span><br><span class="line">var response = client.send(request, HttpResponse.BodyHandlers.ofString());</span><br><span class="line">System.out.println(response.statusCode()); <span class="comment">// 200</span></span><br></pre></td></tr></table></figure><h2 id="多路复用请求"><a href="#多路复用请求" class="headerlink" title="多路复用请求"></a>多路复用请求</h2><p>&emsp;&emsp;HTTP/2的多路复用技术解决了HTTP 1.1中文本串行传输和连接次数过多的问题，提高了网络效率。<br><img src="/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/04.png" alt="HTTP2"></p><p>&emsp;&emsp;多路复用允许同时通过单一的HTTP/2.0连接发起多重的请求-响应消息。在HTTP1.1协议中，浏览器客户端在同一时间，针对同一域名下的请求有一定数量的限制，超过了这个限制的请求就会被阻塞。而多路复用允许同时通过单一的 HTTP2.0 连接发起多重的“请求-响应”消息。</p><p>&emsp;&emsp;HTTP2的请求的TCP的connection一旦建立，后续请求以stream的方式发送。每个stream的基本组成单位是frame（二进制帧）。客户端和服务器可以把 HTTP 消息分解为互不依赖的帧，然后乱序发送，最后再在另一端把它们重新组合起来。<br><img src="/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/05.png" alt="HTTP2多路复用"></p><p>&emsp;&emsp;HTTP客户端API支持HTTP/2的多路复用技术，当我们需要并行请求同一域名时，可以使用这样技术。示例代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">var executor = Executors.newFixedThreadPool(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">var httpClient = HttpClient.newBuilder()</span><br><span class="line">                .version(Version.HTTP_2)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">var mainRequest = HttpRequest.newBuilder()</span><br><span class="line">                .uri(URI.create(<span class="string">"https://http2.akamai.com/demo/h2_demo_frame.html"</span>))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">var mainResponse = httpClient.send(mainRequest, BodyHandlers.ofString());</span><br><span class="line"></span><br><span class="line">var futures = <span class="keyword">new</span> ArrayList&lt;Future&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// For each image resource in the main HTML, send a request on a separate thread</span></span><br><span class="line">mainResponse.body().lines()</span><br><span class="line">            .filter(line -&gt; line.trim().startsWith(<span class="string">"&lt;img height"</span>))</span><br><span class="line">            .map(line -&gt; line.substring(line.indexOf(<span class="string">"src='"</span>) + <span class="number">5</span>, line.indexOf(<span class="string">"'/&gt;"</span>)))</span><br><span class="line">            .forEach(image -&gt; &#123;</span><br><span class="line">                var imgFuture = executor.submit(() -&gt; &#123;</span><br><span class="line">                var imgRequest = HttpRequest.newBuilder()</span><br><span class="line">                                 .uri(URI.create(<span class="string">"https://http2.akamai.com"</span> + image))</span><br><span class="line">                                 .build();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var imageResponse = httpClient.send(imgRequest, BodyHandlers.ofString());</span><br><span class="line">                    System.out.println(<span class="string">"Loaded "</span> + image + <span class="string">", status code: "</span> + imageResponse.statusCode());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException | InterruptedException ex) &#123;</span><br><span class="line">                             System.err.println(<span class="string">"Error during image request for "</span> + image);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            futures.add(imgFuture);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wait for all submitted image loads to be completed</span></span><br><span class="line">futures.forEach(f -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        f.get();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException ex) &#123;</span><br><span class="line">        System.err.println(<span class="string">"Error waiting for image load"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="请求头压缩"><a href="#请求头压缩" class="headerlink" title="请求头压缩"></a>请求头压缩</h2><p>&emsp;&emsp;HTTP/1.1的请求头带有大量信息，而且每次都要重复发送。HTTP1.1中的请求头是没有压缩的，gzip只会压缩请求体。一般轮询请求头，特别是cookie会占用很多的空间，请求头压缩会使得整个HTTP请求的数据表小很多，传输也就会更快。HTTP/2 为了减少这部分开销，采用了HPACK请求头压缩算法对头部进行压缩。<br><img src="/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/06.png" alt="头部压缩"></p><p>&emsp;&emsp;HTTP/2的HPACK请求头压缩算法是在服务器和客户端维护一个“请求头表”，表中用索引代码请求头名称，或者请求头键-值对，第一次发送两端都会记住已发送过哪些请求头，下一次发送只需要传输差异的数据，相同的数据直接用索引表示即可，另外还可以选择地对请求头压缩后再传输。按照这样的设计，两次轮询的请求头基本上是一样的，那之后的请求基本只需要发送几个索引即可。<br><img src="/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/07.png" alt="头部压缩"></p><p>&emsp;&emsp;“请求头表”有两种，一种是静态表，即HTTP/2协议内置了常用的一些请求头名和请求头键值对。另一种是动态表，保存自定义的请求头或五花八门的键值对等，动态表可以通过SETTINGS帧的SETTINGS_HEADER_TABLE_SIZE规定大小。</p><p>&emsp;&emsp;在Java 10 中这种请求头压缩算法在“java.net.http” 模块中的“jdk.internal.net.http.hpack”包中实现。</p><h2 id="服务器推送"><a href="#服务器推送" class="headerlink" title="服务器推送"></a>服务器推送</h2><p>&emsp;&emsp;以前，我们通过浏览器基于HTTP/1.1访问网页的时候，服务会将HTML页面作为响应发送给客户端，客户端需要解析这个HTML页面，并重新请求这个页面中嵌入的JavaScript，图片和CSS。HTTP/2的服务器推送允许服务器主动将资源发送到客户端的缓存以供将来使用。服务器可以在建立流后立即开始发送，而无需等待客户端请求它们。例如，可以通过返回所请求的网页来并行地将诸如包含图像的资源推送到客户端。因此，浏览优化（如图像精灵或资源内联）不再有用。所以说，HTTP/2 服务器推送是一种提升首屏加载速度的技术，它允许 Web 服务器在收到浏览器的请求之前提前发送一些资源给客户端。</p><p>&emsp;&emsp;值得注意的是，HTTP/2推送并不是要替换随HTML5引入的服务器发送事件或WebSocket。这些HTML5服务器推送技术脱离了HTTP的严格请求-响应语义，这意味着客户端发送HTTP请求并等待直到收到HTTP响应。服务器发送的事件和WebSockets允许服务器在没有先前的HTTP请求的情况下随时发送事件或数据。</p><p>&emsp;&emsp;HTTP/2推送是不同的，因为它仍然基于请求-响应语义。但HTTP/2推送允许服务器响应数据以获得比客户端请求更多的查询。通过发送PUSH_PROMISE帧，服务器将启动推送。 PUSH_PROMISE帧包括用于推送的HTTP响应消息的关联HTTP请求消息数据。例如，PUSH_PROMISE帧包括请求URI或请求方法。PUSH_PROMISE帧之后是HEADER和DATA帧，以将HTTP响应消息进行推送。<br><img src="/images/blog/jdk8_to_jdk11_changes/03_JDK_HTTP_Client/08.jpg" alt="服务器推送"></p><p>&emsp;&emsp;HTTP/2的客户端提供了HttpResponse.PushPromiseHandler接口来处理服务器端推送。</p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/2018/10/03/1/">从Java 8 到Java 11 （语言篇）：二、Java的Http客户端</a></p><p><span>文章作者:</span><a href="/" title="访问 Snowolf Lee 的个人博客">Snowolf Lee</a></p><p><span>发布时间:</span>2018年10月03日 - 10:10</p><p><span>最后更新:</span>2019年01月04日 - 14:01</p><p><span>原始链接:</span><a href="/2018/10/03/1/" title="从Java 8 到Java 11 （语言篇）：二、Java的Http客户端">https://snowolf.gitee.io/2018/10/03/1/</a><span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://snowolf.gitee.io/2018/10/03/1/" aria-label="复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"> <img id="wechat_subscriber_qcode" src="/images/my-blog.png" alt="Snowolf Lee wechat" style="width:200px;max-width:100%"><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/IT技术/" rel="tag"><i class="fa fa-tag"></i> IT技术</a><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a><a href="/tags/新特性/" rel="tag"><i class="fa fa-tag"></i> 新特性</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/09/30/1/" rel="next" title="从Java 8 到Java 11 （语言篇）：一、局部变量类型接口"><i class="fa fa-chevron-left"></i> 从Java 8 到Java 11 （语言篇）：一、局部变量类型接口</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></div></article></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/sai.png" alt="Snowolf Lee"><p class="site-author-name" itemprop="name">Snowolf Lee</p><p class="site-description motion-element" itemprop="description">知行合一 笃行求是</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">3</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">3</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">3</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/sn0wolf" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:wu-wi01@163.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="http://wpa.qq.com/msgrd?v=3&uin=278738302&site=qq&menu=yes" target="_blank" title="QQ"><i class="fa fa-fw fa-qq"></i> QQ</a></span><span class="links-of-author-item"><a href="http://weibo.com/snow0lf" target="_blank" title="微博"><i class="fa fa-fw fa-weibo"></i> 微博</a></span><span class="links-of-author-item"><a href="https://www.douban.com/people/105358046/" target="_blank" title="豆瓣"><i class="fa fa-fw fa-globe"></i> 豆瓣</a></span><span class="links-of-author-item"><a href="http://www.zhihu.com/people/snowo1f" target="_blank" title="知乎"><i class="fa fa-fw fa-globe"></i> 知乎</a></span><span class="links-of-author-item"><a href="https://www.jianshu.com/u/6fc3b2c9102b" target="_blank" title="简书"><i class="fa fa-fw fa-globe"></i> 简书</a></span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><h3 class="widget-title">标签</h3><div id="myCanvasContainer" class="widget tagcloud"><canvas width="250" height="250" id="resCanvas" style=""><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/IT技术/">IT技术</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/新特性/">新特性</a><span class="tag-list-count">3</span></li></ul></canvas></div></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是HTTP-2"><span class="nav-number">1.</span> <span class="nav-text">什么是HTTP/2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Http客户端API基本使用"><span class="nav-number">2.</span> <span class="nav-text">Http客户端API基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#引入Http客户端模块"><span class="nav-number">2.1.</span> <span class="nav-text">引入Http客户端模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建HTTP客户端"><span class="nav-number">2.2.</span> <span class="nav-text">创建HTTP客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建HTTP请求"><span class="nav-number">2.3.</span> <span class="nav-text">创建HTTP请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理HTTP响应"><span class="nav-number">2.4.</span> <span class="nav-text">处理HTTP响应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送HTTP请求"><span class="nav-number">2.5.</span> <span class="nav-text">发送HTTP请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基本请求认证"><span class="nav-number">2.6.</span> <span class="nav-text">基本请求认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用代理"><span class="nav-number">2.7.</span> <span class="nav-text">使用代理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多路复用请求"><span class="nav-number">3.</span> <span class="nav-text">多路复用请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#请求头压缩"><span class="nav-number">4.</span> <span class="nav-text">请求头压缩</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务器推送"><span class="nav-number">5.</span> <span class="nav-text">服务器推送</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2019</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Snowolf Lee</span></div><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_uv">本站访客数:<span id="busuanzi_value_site_uv"></span></span></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共7.9k字</span></div><div class="weixin-box"><div class="weixin-menu"><div class="weixin-hover"><div class="weixin-description">微信扫一扫，订阅本博客</div></div></div></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/reading_progress/reading_progress.js"></script><script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script><script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=6.4.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script type="text/javascript">var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!1,notify:!1,appId:"AcrDrefUNVwsjXVAjBVCHab9-gzGzoHsz",appKey:"geP0VJ24eaKXsQlCYq3uWX3M",placeholder:"Just go go",avatar:"mm",meta:guest,pageSize:"10",visitor:!1})</script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>
    
    function showTime(Counter) {
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url: { "$in": entries } }) })
        .done(function ({ results }) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.url;
            var time = item.time;
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function ({ responseJSON }) {
          console.log("LeanCloud Counter Error: " + responseJSON.code + " " + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "AcrDrefUNVwsjXVAjBVCHab9-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "AcrDrefUNVwsjXVAjBVCHab9-gzGzoHsz",
                'X-LC-Key': "geP0VJ24eaKXsQlCYq3uWX3M",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          if ($('.post-title-link').length >= 1) {
            showTime(Counter);
          }
          
        })
    });
  </script><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0309d2e3.js","daovoice"),daovoice("init",{app_id:"0309d2e3"}),daovoice("update")</script></body></html>